<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>11.2. Web Server (HTTP)</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css" /><link rel="stylesheet" media="print" href="Common_Content/css/print.css" type="text/css" /><meta name="generator" content="publican 3.0" /><meta name="package" content="Debian-debian-handbook-6.0-en-US-1.0-1" /><meta name="keywords" content="Postfix, Apache, NFS, Samba, Squid, OpenLDAP" /><link rel="home" href="index.html" title="The Debian Administrator's Handbook" /><link rel="up" href="network-services.html" title="Chapter 11. Network Services: Postfix, Apache, NFS, Samba, Squid, LDAP" /><link rel="prev" href="network-services.html" title="Chapter 11. Network Services: Postfix, Apache, NFS, Samba, Squid, LDAP" /><link rel="next" href="sect.ftp-file-server.html" title="11.3. FTP File Server" /></head><body><p class="hidden" id="title"><a class="left" href="http://www.debian.org"><img src="Common_Content/images/image_left.png" alt="Product Site" /></a><a class="right" href="http://debian-handbook.info"><img src="Common_Content/images/image_right.png" alt="Documentation Site" /></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="network-services.html"><strong>Prev</strong></a></li><li class="home">The Debian Administrator's Handbook</li><li class="next"><a accesskey="n" href="sect.ftp-file-server.html"><strong>Next</strong></a></li></ul><div class="section"><div class="titlepage"><div><div><h2 class="title" id="sect.http-web-server">11.2. Web Server (HTTP)</h2></div></div></div><div class="para"><p></p>
			The Falcot Corp administrators decided to use the Apache HTTP server, included in Debian <span class="distribution distribution">Squeeze</span> at version 2.2.16.
		</div><a id="idp10994224" class="indexterm"></a><a id="idp10994784" class="indexterm"></a><a id="idp10995504" class="indexterm"></a><a id="idp10995984" class="indexterm"></a><a id="idp10996704" class="indexterm"></a><div class="sidebar"><div class="titlepage"><div><div><h6><span class="emphasis"><em>ALTERNATIVE</em></span> Other web servers</h6></div></div></div><div class="para"><p></p>
			Apache is merely the most widely-known (and widely-used) web server, but there are others; they can offer better performance under certain workloads, but this has its counterpart in the smaller number of available features and modules. However, when the prospective web server is built to serve static files or to act as a proxy, the alternatives, such as <span class="pkg pkg">nginx</span> and <span class="pkg pkg">lighttpd</span>, are worth investigating.
		</div><a id="idp10999368" class="indexterm"></a><a id="idp11000080" class="indexterm"></a></div><div class="section"><div class="titlepage"><div><div><h3 class="title" id="idp11000872">11.2.1. Installing Apache</h3></div></div></div><div class="para"><p></p>
				By default, installing the <span class="pkg pkg">apache2</span> package causes the <span class="pkg pkg">apache2-mpm-worker</span> version of Apache to be installed too. The <span class="pkg pkg">apache2</span> package is an empty shell, and it only serves to ensure that one of the Apache versions is actually installed.
			</div><div class="para"><p></p>
				The differences between the variants of Apache 2 are concentrated in the policy used to handle parallel processing of many requests; this policy is implemented by an MPM (short for <span class="emphasis"><em>Multi-Processing Module</em></span>). Among the available MPMs, <span class="pkg pkg">apache2-mpm-worker</span> uses <span class="emphasis"><em>threads</em></span> (lightweight processes), whereas <span class="pkg pkg">apache2-mpm-prefork</span> uses a pool of processes created in advance (the traditional way, and the only one available in Apache 1.3). <span class="pkg pkg">apache2-mpm-event</span> also uses threads, but they are terminated earlier, when the incoming connection is only kept open by the HTTP <span class="emphasis"><em>keep-alive</em></span> feature.
			</div><div class="para"><p></p>
				The Falcot administrators also install <span class="pkg pkg">libapache2-mod-php5</span> so as to include the PHP support in Apache. This causes <span class="pkg pkg">apache2-mpm-worker</span> to be removed, and <span class="pkg pkg">apache2-mpm-prefork</span> to be installed in its stead, since PHP only works under that particular MPM.
			</div><div class="sidebar"><div class="titlepage"><div><div><h6><span class="emphasis"><em>SECURITY</em></span> Execution under the <code class="literal">www-data</code> user</h6></div></div></div><a id="idp11007592" class="indexterm"></a><a id="idp11008152" class="indexterm"></a><div class="para"><p></p>
				By default, Apache handles incoming requests under the identity of the <code class="literal">www-data</code> user. This means that a security vulnerability in a CGI script executed by Apache (for a dynamic page) won't compromise the whole system, but only the files owned by this particular user.
			</div><div class="para"><p></p>
				Using the <span class="emphasis"><em>suexec</em></span> modules allows bypassing this rule so that some CGI scripts are executed under the identity of another user. This is configured with a <code class="literal">SuexecUserGroup <em class="replaceable"><code>user</code></em><em class="replaceable"><code>group</code></em></code> directive in the Apache configuration.
			</div><a id="idp11010488" class="indexterm"></a><div class="para"><p></p>
				Another possibility is to use a dedicated MPM, such as the one provided by <span class="pkg pkg">apache2-mpm-itk</span>. This particular one has a slightly different behaviour: it allows “isolating” virtual hosts so that they each run as a different user. A vulnerability in one website therefore cannot compromise files belonging to the owner of another website.
			</div></div><div class="sidebar"><div class="titlepage"><div><div><h6><span class="emphasis"><em>QUICK LOOK</em></span> List of modules</h6></div></div></div><div class="para"><p></p>
				The full list of Apache standard modules can be found online. <div xmlns="" class="url">→ <a xmlns="http://www.w3.org/1999/xhtml" href="http://httpd.apache.org/docs/2.2/mod/index.html">http://httpd.apache.org/docs/2.2/mod/index.html</a></div>
			</div></div><div class="para"><p></p>
				Apache is a modular server, and many features are implemented by external modules that the main program loads during its initialization. The default configuration only enables the most common modules, but enabling new modules is a simple matter of running <code class="command">a2enmod <em class="replaceable"><code>module</code></em></code>; to disable a module, the command is <code class="command">a2dismod <em class="replaceable"><code>module</code></em></code>. These programs actually only create (or delete) symbolic links in <code class="filename">/etc/apache2/mods-enabled/</code>, pointing at the actual files (stored in <code class="filename">/etc/apache2/mods-available/</code>).
			</div><div class="para"><p></p>
				With its default configuration, the web server listens on port 80 (as configured in <code class="filename">/etc/apache2/ports.conf</code>), and serves pages from the <code class="filename">/var/www/</code> directory (as configured in <code class="filename">/etc/apache2/sites-enabled/000-default</code>).
			</div><div class="sidebar"><div class="titlepage"><div><div><h6><span class="emphasis"><em>GOING FURTHER</em></span> Adding support for SSL</h6></div></div></div><a id="idp11017024" class="indexterm"></a><a id="idp11017504" class="indexterm"></a><div class="para"><p></p>
				Apache 2.2 includes the SSL module required for secure HTTP (HTTPS) out of the box. It just needs to be enabled with <code class="command">a2enmod ssl</code>, then the required directives have to be added to the configuration files. A configuration example is provided in <code class="filename">/usr/share/doc/apache2.2-common/examples/apache2/extra/httpd-ssl.conf.gz</code>. <div xmlns="" class="url">→ <a xmlns="http://www.w3.org/1999/xhtml" href="http://httpd.apache.org/docs/2.2/mod/mod_ssl.html">http://httpd.apache.org/docs/2.2/mod/mod_ssl.html</a></div>
			</div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title" id="idp11019888">11.2.2. Configuring Virtual Hosts</h3></div></div></div><div class="para"><p></p>
				A virtual host is an extra identity for the web server.
			</div><a id="idp11020568" class="indexterm"></a><div class="para"><p></p>
				Apache considers two different kinds of virtual hosts: those that are based on the IP address (or the port), and those that rely on the domain name of the web server. The first method requires allocating a different IP address (or port) for each site, whereas the second one can work on a single IP address (and port), and the sites are differenciated by the hostname sent by the HTTP client (which only works in version 1.1 of the HTTP protocol — fortunately that version is old enough that all clients use it already).
			</div><div class="para"><p></p>
				The (increasing) scarcity of IPv4 addresses usually favours the second method; however, it is made more complex if the virtual hosts need to provide HTTPS too, since the SSL protocol hasn't always provided for name-based virtual hosting; the SNI extension (<span class="emphasis"><em>Server Name Indication</em></span>) that allows such a combination is not handled by all browsers. When several HTTPS sites need to run on the same server, they will usually be differenciated either by running on a different port or on a different IP address (IPv6 can help there).
			</div><div class="para"><p></p>
				The default configuration for Apache 2 enables name-based virtual hosts (with the <code class="literal">NameVirtualHost *:80</code> directive in the <code class="filename">/etc/apache2/ports.conf</code> file). In addition, a default virtual host is defined in the <code class="literal">/etc/apache2/sites-enabled/000-default</code> file; this virtual host will be used if no host matching the request sent by the client is found.
			</div><div class="sidebar important"><div class="titlepage"><div><div><h6><span class="emphasis"><em>CAUTION</em></span> First virtual host</h6></div></div></div><div class="para"><p></p>
				Requests concerning unknown virtual hosts will always be served by the first defined virtual host, which is why we defined <code class="literal">www.falcot.com</code> first here.
			</div></div><div class="sidebar"><div class="titlepage"><div><div><h6><span class="emphasis"><em>QUICK LOOK</em></span> Apache supports SNI</h6></div></div></div><a id="idp11025768" class="indexterm"></a><div class="para"><p></p>
				Starting with Debian <span class="distribution distribution">Squeeze</span>, the Apache server supports an SSL protocol extension called <span class="emphasis"><em>Server Name Indication</em></span> (SNI). This extension allows the browser to send the hostname of the web server during the establishment of the SSL connection, much earlier than the HTTP request itself, which was previously used to identify the requested virtual host among those hosted on the same server (with the same IP address and port). This allows Apache to select the most appropriate SSL certificate for the transaction to proceed.
			</div><div class="para"><p></p>
				Before SNI, Apache would always use the certificate defined in the default virtual host. Clients trying to access another virtual host would then display warnings, since the certificate they received didn't match the website they were trying to access. Fortunately, most browsers now work with SNI; this includes Microsoft Internet Explorer starting with version 7.0 (starting on Vista), Mozilla Firefox starting with version 2.0, Apple Safari since version 3.2.1, and all versions of Google Chrome.
			</div><div class="para"><p></p>
				The Apache package provided in Debian is built with support for SNI; no particular configuration is therefore needed, apart from enabling name-based virtual hosting on port 443 (SSL) as well as the usual port 80. This is a simple matter of editing <code class="filename">/etc/apache2/ports.conf</code> so it includes the following:
			</div><pre class="programlisting">
&lt;IfModule mod_ssl.c&gt;
    NameVirtualHost *:443
    Listen 443
&lt;/IfModule&gt;
</pre><div class="para"><p></p>
				Care should also be taken to ensure that the configuration for the first virtual host (the one used by default) does enable TLSv1, since Apache uses the parameters of this first virtual host to establish secure connections, and they had better allow them!
			</div></div><div class="para"><p></p>
				Each extra virtual host is then described by a file stored in <code class="filename">/etc/apache2/sites-available/</code>. Setting up a website for the <code class="literal">falcot.org</code> domain is therefore a simple matter of creating the following file, then enabling the virtual host with <code class="command">a2ensite www.falcot.org</code>.
			</div><div class="example"><h6>Example 11.16. The <code class="filename">/etc/apache2/sites-available/www.falcot.org</code> file</h6><div class="example-contents"><pre class="programlisting">
&lt;VirtualHost *:80&gt;
ServerName www.falcot.org
ServerAlias falcot.org
DocumentRoot /srv/www/www.falcot.org
&lt;/VirtualHost&gt;
</pre></div></div><br class="example-break" /><div class="para"><p></p>
				The Apache server, as configured so far, uses the same log files for all virtual hosts (although this could be changed by adding <code class="literal">CustomLog</code> directives in the definitions of the virtual hosts). It therefore makes good sense to customize the format of this log file to have it include the name of the virtual host. This can be done by creating a <code class="filename">/etc/apache2/conf.d/customlog</code> file that defines a new format for all log files (with the <code class="literal">LogFormat</code> directive). The <code class="literal">CustomLog</code> line must also be removed (or commented out) from the <code class="filename">/etc/apache2/sites-available/default</code> file.
			</div><div class="example"><h6>Example 11.17. The <code class="filename">/etc/apache2/conf.d/customlog</code> file</h6><div class="example-contents"><pre class="programlisting scale">
# New log format including (virtual) host name
LogFormat "%v %h %l %u %t \"%r\" %&gt;s %b \"%{Referer}i\" \"%{User-Agent}i\"" vhost

# Now let's use this "vhost" format by default
CustomLog /var/log/apache2/access.log vhost
</pre></div></div><br class="example-break" /></div><div class="section"><div class="titlepage"><div><div><h3 class="title" id="idp11035328">11.2.3. Common Directives</h3></div></div></div><div class="para"><p></p>
				This section briefly reviews some of the commonly-used Apache configuration directives. 
				<a id="idp11035960" class="indexterm"></a>
				 <a id="idp11036424" class="indexterm"></a>
			</div><div class="para"><p></p>
				The main configuration file usually includes several <code class="literal">Directory</code> blocks; they allow specifying different behaviors for the server depending on the location of the file being served. Such a block commonly includes <code class="literal">Options</code> and <code class="literal">AllowOverride</code> directives. 
				<a id="idp11038008" class="indexterm"></a>
			</div><a id="idp11038712" class="indexterm"></a><div class="example"><h6>Example 11.18. Directory block</h6><div class="example-contents"><pre class="programlisting">
&lt;Directory /var/www&gt;
Options Includes FollowSymlinks
AllowOverride All
DirectoryIndex index.php index.html index.htm
&lt;/Directory&gt;
</pre></div></div><br class="example-break" /><div class="para"><p></p>
				The <code class="literal">DirectoryIndex</code> directive contains a list of files to try when the client request matches a directory. The first existing file in the list is used and sent as a response. 
				<a id="idp11040664" class="indexterm"></a>
			</div><div class="para"><p></p>
				<a id="idp11041512" class="indexterm"></a>
				 The <code class="literal">Options</code> directive is followed by a list of options to enable. The <code class="literal">None</code> value disables all options; correspondingly, <code class="literal">All</code> enables them all except <code class="literal">MultiViews</code>. Available options include:
			</div><div class="itemizedlist"><ul><li class="listitem"><div class="para"><p></p>
						<code class="literal">ExecCGI</code> indicates that CGI scripts can be executed. 
						<a id="idp11044024" class="indexterm"></a>
					</div></li><li class="listitem"><div class="para"><p></p>
						<code class="literal">FollowSymlinks</code> tells the server that symbolic links can be followed, and that the response should contain the contents of the target of such links. 
						<a id="idp11045488" class="indexterm"></a>
					</div></li><li class="listitem"><div class="para"><p></p>
						<code class="literal">SymlinksIfOwnerMatch</code> also tells the server to follow symbolic links, but only when the link and the its target have the same owner. 
						<a id="idp11046912" class="indexterm"></a>
					</div></li><li class="listitem"><div class="para"><p></p>
						<code class="literal">Includes</code> enables <span class="emphasis"><em>Server Side Includes</em></span> (<span class="emphasis"><em>SSI</em></span> for short). These are directives embedded in HTML pages and executed on the fly for each request. 
						<a id="idp11048800" class="indexterm"></a>
					</div></li><li class="listitem"><div class="para"><p></p>
						<code class="literal">Indexes</code> tells the server to list the contents of a directory if the HTTP request sent by the client points at a directory without an index file (ie, when no files mentioned by the <code class="literal">DirectoryIndex</code> directive exists in this directory). 
						<a id="idp11050576" class="indexterm"></a>
					</div></li><li class="listitem"><div class="para"><p></p>
						<code class="literal">MultiViews</code> enables content negociation; this can be used by the server to return a web page matching the preferred language as configured in the browser. 
						<a id="idp11052064" class="indexterm"></a>
					</div></li></ul></div><div class="para"><p></p>
			</div><div class="sidebar"><div class="titlepage"><div><div><h6><span class="emphasis"><em>BACK TO BASICS</em></span> <code class="filename">.htaccess</code> file</h6></div></div></div><div class="para"><p></p>
				The <code class="filename">.htaccess</code> file contains Apache configuration directives enforced each time a request concerns an element of the directory where it is stored. The scope of these directives also recurses to all the subdirectories within.
			</div><a id="idp11054640" class="indexterm"></a><div class="para"><p></p>
				Most of the directives that can occur in a <code class="literal">Directory</code> block are also legal in a <code class="filename">.htaccess</code> file.
			</div></div><div class="para"><p></p>
				The <code class="literal">AllowOverride</code> directive lists all the options that can be enabled or disabled by way of a <code class="filename">.htaccess</code> file. A common use of this option is to restrict <code class="literal">ExecCGI</code>, so that the administrator chooses which users are allowed to run programs under the web server's identity (the <code class="literal">www-data</code> user).
			</div><a id="idp11057424" class="indexterm"></a><div class="section"><div class="titlepage"><div><div><h4 class="title" id="idp11058032">11.2.3.1. Requiring an Authentication</h4></div></div></div><a id="idp11058416" class="indexterm"></a><div class="para"><p></p>
					In some circumstances, access to part of a website needs to be restricted, so only legitimate users who provide a username and a password are granted access to the contents.
				</div><div class="example"><h6>Example 11.19. <code class="filename">.htaccess</code> file requiring an authentication</h6><div class="example-contents"><pre class="programlisting">
Require valid-user
AuthName "Private directory"
AuthType Basic
AuthUserFile /etc/apache2/authfiles/htpasswd-private
</pre></div></div><br class="example-break" /><div class="sidebar important"><div class="titlepage"><div><div><h6><span class="emphasis"><em>SECURITY</em></span> No security</h6></div></div></div><div class="para"><p></p>
					The authentication system used in the above example (<code class="literal">Basic</code>) has minimal security as the password is sent in clear text (it is only encoded as <span class="emphasis"><em>base64</em></span>, which is a simple encoding rather than an encryption method). It should also be noted that the documents “protected” by this mechanism also go over the network in the clear. If security is important, the whole HTTP connection should be encrypted with SSL.
				</div></div><div class="para"><p></p>
					The <code class="filename">/etc/apache2/authfiles/htpasswd-private</code> file contains a list of users and passwords; it is commonly manipulated with the <code class="command">htpasswd</code> command. For example, the following command is used to add a user or change their password: 
					<a id="idp11063008" class="indexterm"></a>
				</div><pre class="screen">
<code class="computeroutput"># </code><strong class="userinput"><code>htpasswd /etc/apache2/authfiles/htpasswd-private <em class="replaceable"><code>user</code></em>
</code></strong><code class="computeroutput">New password:
Re-type new password:
Adding password for user <em class="replaceable"><code>user</code></em>
</code></pre></div><div class="section"><div class="titlepage"><div><div><h4 class="title" id="idp11064992">11.2.3.2. Restricting Access</h4></div></div></div><a id="idp11065376" class="indexterm"></a><div class="para"><p></p>
					The <code class="literal">Allow from</code> and <code class="literal">Deny from</code> directives control access restrictions for a directory (and its subdirectories, recursively). 
					<a id="idp11066576" class="indexterm"></a>
					 <a id="idp11067040" class="indexterm"></a>
					 <a id="idp11067504" class="indexterm"></a>
					 <a id="idp11068128" class="indexterm"></a>
					 <a id="idp11068752" class="indexterm"></a>
				</div><div class="para"><p></p>
					The <code class="literal">Order</code> directive tells the server of the order in which the <code class="literal">Allow from</code> and <code class="literal">Deny from</code> directives are applied; the last one that matches takes precedence. In concrete terms, <code class="literal">Order deny,allow</code> allows access if no <code class="literal">Deny from</code> applies, or if an <code class="literal">Allow from</code> directive does. Conversely, <code class="literal">Order allow,deny</code> rejects access if no <code class="literal">Allow from</code> directive matches (or if a <code class="literal">Deny from</code> directive applies).
				</div><div class="para"><p></p>
					The <code class="literal">Allow from</code> and <code class="literal">Deny from</code> directives can be followed by an IP address, a network (such as <code class="literal">192.168.0.0/255.255.255.0</code>, <code class="literal">192.168.0.0/24</code> or even <code class="literal">192.168.0</code>), a hostname or a domain name, or the <code class="literal">all</code> keyword, designating everyone.
				</div><div class="example"><h6>Example 11.20. Reject by default but allow from the local network</h6><div class="example-contents"><pre class="programlisting">
Order deny,allow
Allow from 192.168.0.0/16
Deny from all
</pre></div></div><br class="example-break" /></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title" id="idp9346424">11.2.4. Log Analyzers</h3></div></div></div><div class="para"><p></p>
				A log analyzer is frequently installed on a web server; since the former provides the administrators with a precise idea of the usage patterns of the latter.
			</div><div class="para"><p></p>
				The Falcot Corp administrators selected <span class="emphasis"><em>AWStats</em></span> (<span class="emphasis"><em>Advanced Web Statistics</em></span>) to analyze their Apache log files.
			</div><a id="idp9347984" class="indexterm"></a><a id="idp9348544" class="indexterm"></a><a id="idp9349008" class="indexterm"></a><div class="para"><p></p>
				The first configuration step is the creation of the <code class="filename">/etc/awstats/awstats.conf</code> file. The <code class="filename">/usr/share/doc/awstats/examples/awstats.model.conf.gz</code> template is a recommended starting point, and the Falcot administrators keep it unchanged apart from the following parameters:
			</div><pre class="programlisting">
LogFile="/var/log/apache2/access.log"
LogFormat = "%virtualname %host %other %logname %time1 %methodurl %code %bytesd %refererquot %uaquot"
SiteDomain="www.falcot.com"
HostAliases="falcot.com REGEX[^.*\.falcot\.com$]"
DNSLookup=1
DirData="/var/lib/awstats"
DirIcons="/awstats-icon"
DirLang="/usr/share/awstats/lang"
LoadPlugin="tooltips"
</pre><div class="para"><p></p>
				All these parameters are documented by comments in the template file. In particular, the <code class="varname">LogFile</code> and <code class="varname">LogFormat</code> parameters describe the location and format of the log file and the information it contains; <code class="varname">SiteDomain</code> and <code class="varname">HostAliases</code> list the various names under which the main web site is known.
			</div><div class="para"><p></p>
				For high traffic sites, <code class="varname">DNSLookup</code> should usually not be set to <code class="literal">1</code>; for smaller sites, such as the Falcot one described above, this setting allows getting more readable reports that include full machine names instead of raw IP addresses.
			</div><div class="sidebar important"><div class="titlepage"><div><div><h6><span class="emphasis"><em>SECURITY</em></span> Access to statistics</h6></div></div></div><div class="para"><p></p>
				AWStats makes its statistics available on the website with no restrictions by default, but restrictions can be set up so that only a few (probably internal) IP addresses can access them; the list of allowed IP addresses needs to be defined in the <code class="varname">AllowAccessFromWebToFollowingIPAddresses</code> parameter
			</div></div><div class="para"><p></p>
				AWStats will also be enabled for other virtual hosts; each virtual host needs its own configuration file, such as <code class="filename">/etc/awstats/awstats.www.falcot.org.conf</code>.
			</div><div class="example"><h6>Example 11.21. AWStats configuration file for a virtual host</h6><div class="example-contents"><pre class="programlisting">
Include "/etc/awstats/awstats.conf"
SiteDomain="www.falcot.org"
HostAliases="falcot.org"
</pre></div></div><br class="example-break" /><div class="para"><p></p>
				This will only work if the <code class="filename">/etc/awstats/awstats.conf</code> file does not contain any <code class="literal">Include</code> directive, since AWStats cannot handle multi-level inclusions; unfortunately, the default file provided by Debian does contain such a directive.
			</div><div class="para"><p></p>
				To have this new virtual host taken into account, the <code class="filename">/etc/cron.d/awstats</code> needs to be edited to add an invocation such as the following: <code class="command">/usr/lib/cgi-bin/awstats.pl -config=www.falcot.org -update</code>
			</div><div class="example"><h6>Example 11.22. The <code class="filename">/etc/cron.d/awstats</code> file</h6><div class="example-contents"><pre class="programlisting">
0,10,20,30,40,50 * * * * www-data [ -x /usr/lib/cgi-bin/awstats.pl -a -f /etc/awstats/awstats.conf -a -r /var/log/apache/access.log ] &amp;&amp; /usr/lib/cgi-bin/awstats.pl -config=awstats -update &gt;/dev/null &amp;&amp; /usr/lib/cgi-bin/awstats.pl -config=www.falcot.org -update &gt;/dev/null
</pre></div></div><br class="example-break" /><div class="para"><p></p>
				AWStats uses many icons stored in the <code class="filename">/usr/share/awstats/icon/</code> directory. In order for these icons to be available on the web site, the Apache configuration needs to be adapted to include the following directive:
			</div><pre class="programlisting">
Alias /awstats-icon/ /usr/share/awstats/icon/
</pre><div class="para"><p></p>
				After a few minutes (and once the script has been run a few times), the results are available online: <div xmlns="" class="url">→ <a xmlns="http://www.w3.org/1999/xhtml" href="http://www.falcot.com/cgi-bin/awstats.pl">http://www.falcot.com/cgi-bin/awstats.pl</a></div><div xmlns="" class="url">→ <a xmlns="http://www.w3.org/1999/xhtml" href="http://www.falcot.org/cgi-bin/awstats.pl">http://www.falcot.org/cgi-bin/awstats.pl</a></div>
			</div><div class="sidebar"><div class="titlepage"><div><div><h6><span class="emphasis"><em>CAUTION</em></span> Log file rotation</h6></div></div></div><div class="para"><p></p>
				In order for the statistics to take all the logs into account, <span class="emphasis"><em>AWStats</em></span> needs to be run right before the Apache log files are rotated. This can be achieved by adding a <code class="literal">prerotate</code> directive to the <code class="filename">/etc/logrotate.d/apache2</code> file:
			</div><pre class="programlisting">
/var/log/apache2/*.log {
  weekly
  missingok
  rotate 52
  compress
  delaycompress
  notifempty
  create 644 root adm
  sharedscripts
  prerotate
    su - www-data -c "/usr/lib/cgi-bin/awstats.pl -config=awstats -update &gt; /dev/null"
    su - www-data -c "/usr/lib/cgi-bin/awstats.pl -config=www.falcot.org -update &gt; /dev/null"
  endscript
  postrotate
    if [ -f /var/run/apache2.pid ]; then
      /etc/init.d/apache2 restart &gt; /dev/null
    fi
  endscript
}
</pre><div class="para"><p></p>
				Note also that the log files created by <code class="command">logrotate</code> need to be readable by everyone, especially AWStats. In the above example, this is ensured by the <code class="literal">create 644 root adm</code> line.
			</div></div></div></div><div id="site_footer"></div><script type="text/javascript">
		$("#site_footer").load("../../../../../footer.html");
	</script><ul class="docnav"><li class="previous"><a accesskey="p" href="network-services.html"><strong>Prev</strong>Chapter 11. Network Services: Postfix, Apache, NF...</a></li><li class="up"><a accesskey="u" href="#"><strong>Up</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Home</strong></a></li><li class="next"><a accesskey="n" href="sect.ftp-file-server.html"><strong>Next</strong>11.3. FTP File Server</a></li></ul></body></html>
