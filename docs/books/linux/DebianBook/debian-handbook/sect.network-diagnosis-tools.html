<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>10.8. Network Diagnosis Tools</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css" /><link rel="stylesheet" media="print" href="Common_Content/css/print.css" type="text/css" /><meta name="generator" content="publican 3.0" /><meta name="package" content="Debian-debian-handbook-6.0-en-US-1.0-1" /><meta name="keywords" content="Network, Gateway, TCP/IP, IPv6, DNS, Bind, DHCP, QoS" /><link rel="home" href="index.html" title="The Debian Administrator's Handbook" /><link rel="up" href="network-infrastructure.html" title="Chapter 10. Network Infrastructure" /><link rel="prev" href="sect.dhcp.html" title="10.7. DHCP" /><link rel="next" href="network-services.html" title="Chapter 11. Network Services: Postfix, Apache, NFS, Samba, Squid, LDAP" /></head><body><p class="hidden" id="title"><a class="left" href="http://www.debian.org"><img src="Common_Content/images/image_left.png" alt="Product Site" /></a><a class="right" href="http://debian-handbook.info"><img src="Common_Content/images/image_right.png" alt="Documentation Site" /></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="sect.dhcp.html"><strong>Prev</strong></a></li><li class="home">The Debian Administrator's Handbook</li><li class="next"><a accesskey="n" href="network-services.html"><strong>Next</strong></a></li></ul><div class="section"><div class="titlepage"><div><div><h2 class="title" id="sect.network-diagnosis-tools">10.8. Network Diagnosis Tools</h2></div></div></div><div class="para"><p></p>
			When a network application does not run as expected, it is important to be able to look under the hood. Even when everything seems to run smoothly, running a network diagnosis can help ensure everything is working as it should. Several diagnosis tools exists for this purpose; each one operates on a different level.
		</div><div class="section"><div class="titlepage"><div><div><h3 class="title" id="section.netstat">10.8.1. Local Diagnosis: <code class="command">netstat</code></h3></div></div></div><a id="idp10799656" class="indexterm"></a><div class="para"><p></p>
				Let's first mention the <code class="command">netstat</code> command (in the <span class="pkg pkg">net-tools</span> package); it displays an instant summary of a machine's network activity. When invoked with no argument, this command lists all open connections; this list can be very verbose since it includes many Unix-domain sockets (widely used by daemons) which do not involve the network at all (for example, <code class="literal">dbus</code> communication, <code class="literal">X11</code> traffic, and communications between virtual filesystems and the desktop).
			</div><div class="para"><p></p>
				Common invocations therefore use options that alter <code class="command">netstat</code>'s behavior. The most frequently used options include:
			</div><div class="itemizedlist"><ul><li class="listitem"><div class="para"><p></p>
						<code class="literal">-t</code>, which filters the results to only include TCP connections;
					</div></li><li class="listitem"><div class="para"><p></p>
						<code class="literal">-u</code>, which works similarly for UDP connections; these options are not mutually exclusive, and one of them is enough to stop displaying Unix-domain connections;
					</div></li><li class="listitem"><div class="para"><p></p>
						<code class="literal">-a</code>, to also list listening sockets (waiting for incoming connections);
					</div></li><li class="listitem"><div class="para"><p></p>
						<code class="literal">-n</code>, to display the results numerically: IP addresses (no DNS resolution), port numbers (no aliases as defined in <code class="filename">/etc/services</code>) and user ids (no login names);
					</div></li><li class="listitem"><div class="para"><p></p>
						<code class="literal">-p</code>, to list the processes involved; this option is only useful when <code class="command">netstat</code> is run as root, since normal users will only see their own processes;
					</div></li><li class="listitem"><div class="para"><p></p>
						<code class="literal">-c</code>, to continuously refresh the list of connections.
					</div></li></ul></div><div class="para"><p></p>
				Other options, documented in the <span class="citerefentry"><span class="refentrytitle">netstat</span>(8)</span> manual page, provide an even finer control over the displayed results. In practice, the first five options are so often used together that systems and network administrators practically acquired <code class="command">netstat -tupan</code> as a reflex. Typical results, on a lightly loaded machine, may look like the following:
			</div><pre class="screen scale">
<code class="computeroutput"># </code><strong class="userinput"><code>netstat -tupan</code></strong>
<code class="computeroutput">Active Internet connections (servers and established)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name
tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      2224/sshd       
tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      994/exim4       
tcp        0      0 192.168.1.241:22        192.168.1.128:47372     ESTABLISHED 2944/sshd: roland [
tcp        0      0 192.168.1.241:22        192.168.1.128:32970     ESTABLISHED 2232/sshd: roland [
tcp6       0      0 :::22                   :::*                    LISTEN      2224/sshd       
tcp6       0      0 ::1:25                  :::*                    LISTEN      994/exim4       
udp        0      0 0.0.0.0:68              0.0.0.0:*                           633/dhclient    
udp        0      0 192.168.1.241:123       0.0.0.0:*                           764/ntpd        
udp        0      0 127.0.0.1:123           0.0.0.0:*                           764/ntpd        
udp        0      0 0.0.0.0:123             0.0.0.0:*                           764/ntpd        
udp6       0      0 fe80::a00:27ff:fe6c:123 :::*                                764/ntpd        
udp6       0      0 2002:52e0:87e4:0:a0:123 :::*                                764/ntpd        
udp6       0      0 ::1:123                 :::*                                764/ntpd        
udp6       0      0 :::123                  :::*                                764/ntpd        
</code></pre><div class="para"><p></p>
				As expected, this lists established connections, two SSH connections in this case, and applications waiting for incoming connections (listed as <code class="literal">LISTEN</code>), notably the Exim4 email server listening on port 25.
			</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title" id="section.nmap">10.8.2. Remote Diagnosis: <code class="command">nmap</code></h3></div></div></div><a id="idp10813096" class="indexterm"></a><div class="para"><p></p>
				<code class="command">nmap</code> (in the similarly-named package) is, in a way, the remote equivalent for <code class="command">netstat</code>. It can scan a set of “well-known” ports for one or several remote servers, and list the ports where an application is found to answer to incoming connections. Furthermore, <code class="command">nmap</code> is able to identify some of these applications, sometimes even their version number. The counterpart of this tool is that, since it runs remotely, it cannot provide information on processes or users; however, it can operate on several targets at once.
			</div><div class="para"><p></p>
				A typical <code class="command">nmap</code> invocation only uses the <code class="literal">-A</code> option (so that <code class="command">nmap</code> attempts to identify the versions of the server software it finds) followed by one or more IP addresses or DNS names of machines to scan. Again, many more options exist to finely control the behavior of <code class="command">nmap</code>; please refer to the documentation in the <span class="citerefentry"><span class="refentrytitle">nmap</span>(1)</span> manual page.
			</div><pre class="screen scale" width="80">
<code class="computeroutput"># </code><strong class="userinput"><code>nmap scouzmir</code></strong>
<code class="computeroutput">
Starting Nmap 5.00 ( http://nmap.org ) at 2010-10-12 18:52 CEST
Interesting ports on 192.168.1.101:
Not shown: 998 closed ports
PORT    STATE SERVICE
22/tcp  open  ssh
111/tcp open  rpcbind
MAC Address: 52:54:00:99:01:01 (QEMU Virtual NIC)

Nmap done: 1 IP address (1 host up) scanned in 2.11 seconds
# </code><strong class="userinput"><code>nmap -A localhost</code></strong>
<code class="computeroutput">
Starting Nmap 5.00 ( http://nmap.org ) at 2010-10-12 18:59 CEST
Warning: Hostname localhost resolves to 2 IPs. Using 127.0.0.1.
Interesting ports on localhost (127.0.0.1):
Not shown: 997 closed ports
PORT    STATE SERVICE VERSION
22/tcp  open  ssh     OpenSSH 5.5p1 Debian 4 (protocol 2.0)
|  ssh-hostkey: 1024 af:07:60:17:16:64:6f:ee:c4:ca:b5:64:1e:4a:4c:22 (DSA)
|_ 2048 25:b0:aa:6b:11:5a:56:b6:8d:2d:ed:b3:16:17:96:33 (RSA)
25/tcp  open  smtp    Exim smtpd 4.72
|  smtp-commands: EHLO scouzmir.internal.placard.fr.eu.org Hello localhost [127.0.0.1], SIZE 52428800, PIPELINING, HELP
|_ HELP Commands supported: AUTH HELO EHLO MAIL RCPT DATA NOOP QUIT RSET HELP
111/tcp open  rpcbind
|  rpcinfo:  
|  100000  2    111/udp  rpcbind  
|  100024  1  53273/udp  status   
|  100000  2    111/tcp  rpcbind  
|_ 100024  1  41127/tcp  status   
No exact OS matches for host (If you know what OS is running on it, see http://nmap.org/submit/ ).
TCP/IP fingerprint:
OS:SCAN(V=5.00%D=10/12%OT=22%CT=1%CU=34421%PV=N%DS=0%G=Y%TM=4CB4941A%P=i686
OS:-pc-linux-gnu)SEQ(SP=BF%GCD=1%ISR=CC%TI=Z%CI=Z%II=I%TS=8)OPS(O1=M400CST1
OS:1NW4%O2=M400CST11NW4%O3=M400CNNT11NW4%O4=M400CST11NW4%O5=M400CST11NW4%O6
OS:=M400CST11)WIN(W1=8000%W2=8000%W3=8000%W4=8000%W5=8000%W6=8000)ECN(R=Y%D
OS:F=Y%T=40%W=8018%O=M400CNNSNW4%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%A=S+%F=AS%RD=
OS:0%Q=)T2(R=N)T3(R=Y%DF=Y%T=40%W=8000%S=O%A=S+%F=AS%O=M400CST11NW4%RD=0%Q=
OS:)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T5(R=Y%DF=Y%T=40%W=0%S=Z%A=
OS:S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0%Q=)T7(R=Y%DF
OS:=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T=40%IPL=164%UN=0%RIPL=
OS:G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=40%CD=S)

Network Distance: 0 hops
Service Info: Host: scouzmir.internal.placard.fr.eu.org; OS: Linux

OS and Service detection performed. Please report any incorrect results at http://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 21.32 seconds
</code></pre><div class="para"><p></p>
				As expected, the SSH and Exim4 applications are listed. Note that not all applications listen on all IP addresses; since Exim4 is only accessible on the <code class="literal">lo</code> loopback interface, it only appears during an analysis of <code class="literal">localhost</code> and not when scanning <code class="literal">scouzmir</code> (which maps to the <code class="literal">eth0</code> interface on the same machine).
			</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title" id="section.sniffers">10.8.3. Sniffers: <code class="command">tcpdump</code> and <code class="command">wireshark</code></h3></div></div></div><div class="para"><p></p>
				Sometimes, one needs to look at what actually goes on the wire, packet by packet. These cases call for a “frame analyzer”, more widely known as a <span class="emphasis"><em>sniffer</em></span>. Such a tool observes all the packets that reach a given network interface, and displays them in a user-friendly way.
			</div><a id="idp10823872" class="indexterm"></a><div class="para"><p></p>
				The venerable tool in this domain is <code class="command">tcpdump</code>, available as a standard tool on a wide range of platforms. It allows many kinds of network traffic capture, but the representation of this traffic stays rather obscure. We will therefore not describe it in further detail.
			</div><a id="idp10825160" class="indexterm"></a><div class="para"><p></p>
				A more recent (and more modern) tool, <code class="command">wireshark</code> (in the <span class="pkg pkg">wireshark</span> package), is slowly becoming the new reference in network traffic analysis due to its many decoding modules that allow for a simplified analysis of the captured packets. The packets are displayed graphically with an organization based on the protocol layers. This allows a user to visualize all protocols involved in a packet. For example, given a packet containing an HTTP request, <code class="command">wireshark</code> displays, separately, the information concerning the physical layer, the Ethernet layer, the IP packet information, the TCP connection parameters, and finally the HTTP request itself.
			</div><div class="figure"><div class="figure-contents"><div class="mediaobject"><img src="images/wireshark.png" alt="The wireshark network traffic analyzer" /></div></div><h6>Figure 10.1. The <code class="command">wireshark</code> network traffic analyzer</h6></div><br class="figure-break" /><div class="para"><p></p>
				In our example, the packets travelling over SSH are filtered out (with the <code class="literal">!tcp.port == 22</code> filter). The packet currently displayed was developed at the TCP and HTTP layers.
			</div><div class="sidebar"><div class="titlepage"><div><div><h6><span class="emphasis"><em>TIP</em></span> <code class="command">wireshark</code> with no graphical interface: <code class="command">tshark</code></h6></div></div></div><a id="idp10831096" class="indexterm"></a><div class="para"><p></p>
				When one cannot run a graphical interface, or does not wish to do so for whatever reason, a text-only version of <code class="command">wireshark</code> also exists under the name <code class="command">tshark</code> (in a separate <span class="pkg pkg">tshark</span> package). Most of the capture and decoding features are still available, but the lack of a graphical interface necessarily limits the interactions with the program (filtering packets after they've been captured, tracking of a given TCP connection, and so on). It can still be used as a first approach. If further manipulations are intended and require the graphical interface, the packets can be saved to a file and this file can be loaded into a graphical <code class="command">wireshark</code> running on another machine.
			</div></div><div class="sidebar"><div class="titlepage"><div><div><h6><span class="emphasis"><em>CULTURE</em></span> <code class="command">ethereal</code> and <code class="command">wireshark</code></h6></div></div></div><a id="idp10834640" class="indexterm"></a><a id="idp10835200" class="indexterm"></a><div class="para"><p></p>
				<code class="command">wireshark</code> seems to be relatively young; however, it is only the new name for a software application previously known as <code class="command">ethereal</code>. When its main developer left the company where he was employed, he was not able to arrange for the transfer of the registered trademark. As an alternative he went for a name change; only the name and the icons for the software actually changed.
			</div></div></div></div><div id="site_footer"></div><script type="text/javascript">
		$("#site_footer").load("../../../../../footer.html");
	</script><ul class="docnav"><li class="previous"><a accesskey="p" href="sect.dhcp.html"><strong>Prev</strong>10.7. DHCP</a></li><li class="up"><a accesskey="u" href="#"><strong>Up</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Home</strong></a></li><li class="next"><a accesskey="n" href="network-services.html"><strong>Next</strong>Chapter 11. Network Services: Postfix, Apache, NF...</a></li></ul></body></html>
