<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>8.10. Compiling a Kernel</title><link rel="stylesheet" type="text/css" href="Common_Content/css/default.css" /><link rel="stylesheet" media="print" href="Common_Content/css/print.css" type="text/css" /><meta name="generator" content="publican 3.0" /><meta name="package" content="Debian-debian-handbook-6.0-en-US-1.0-1" /><meta name="keywords" content="Configuration, Localization, Locales, Network, Name resolution, Users, Groups, Accounts, Command-line interpreter, Shell, Printing, Bootloader, Kernel compiling" /><link rel="home" href="index.html" title="The Debian Administrator's Handbook" /><link rel="up" href="basic-configuration.html" title="Chapter 8. Basic Configuration: Network, Accounts, Printing..." /><link rel="prev" href="sect.config-misc.html" title="8.9. Other Configurations: Time Synchronization, Logs, Sharing Access..." /><link rel="next" href="sect.kernel-installation.html" title="8.11. Installing a Kernel" /></head><body><p class="hidden" id="title"><a class="left" href="http://www.debian.org"><img src="Common_Content/images/image_left.png" alt="Product Site" /></a><a class="right" href="http://debian-handbook.info"><img src="Common_Content/images/image_right.png" alt="Documentation Site" /></a></p><ul class="docnav"><li class="previous"><a accesskey="p" href="sect.config-misc.html"><strong>Prev</strong></a></li><li class="home">The Debian Administrator's Handbook</li><li class="next"><a accesskey="n" href="sect.kernel-installation.html"><strong>Next</strong></a></li></ul><div class="section"><div class="titlepage"><div><div><h2 class="title" id="sect.kernel-compilation">8.10. Compiling a Kernel</h2></div></div></div><a id="idp10630304" class="indexterm"></a><a id="idp10631024" class="indexterm"></a><a id="idp10631744" class="indexterm"></a><div class="para"><p></p>
			The kernels provided by Debian include the largest possible number of features, as well as the maximum of drivers, in order to cover the broadest spectrum of existing hardware configurations. This is why some users prefer to recompile the kernel in order to only include what they specifically need. There are two reasons for this choice. First, it may be to optimize memory consumption, since the kernel code, even if it is never used, occupies memory for nothing (and never “goes down” on the swap space, since it is actual RAM that it uses), which can decrease overall system performance. A locally compiled kernel can also limit the risk of security problems since only a fraction of the kernel code is compiled and run.
		</div><div class="sidebar"><div class="titlepage"><div><div><h6><span class="emphasis"><em>NOTE</em></span> Security updates</h6></div></div></div><div class="para"><p></p>
			If you choose to compile your own kernel, you must accept the consequences: Debian can not ensure security updates for your custom kernel. By keeping the kernel provided by Debian, you benefit from updates prepared by the Debian Project's security team.
		</div></div><div class="para"><p></p>
			Recompilation of the kernel is also necessary if you want to use certain features that are only available as patches (and not included in the standard kernel version).
		</div><div class="section"><div class="titlepage"><div><div><h3 class="title" id="section.compil-noyau-prerequis">8.10.1. Introduction and Prerequisites</h3></div></div></div><a id="idp10635640" class="indexterm"></a><div class="para"><p></p>
				Debian manages the kernel in the form of a package, which is not how kernels have traditionally been compiled and installed. Specific tools have therefore been developed for this purpose. They allow easy creation of a Debian package from Linux kernel sources, possibly adding patches along the way. Since the kernel remains under the control of the packaging system, it can then be removed cleanly, or deployed on several machines. Furthermore, the scripts associated with these packages automate the interaction with the bootloader.
			</div><div class="para"><p></p>
				To compile a Linux kernel the Debian way, you will need to use the tools included in the <span class="pkg pkg">kernel-package</span> package. Furthermore, the configuration step for the kernel requires the <span class="emphasis"><em>libncurses5-dev</em></span> package. Finally, the <span class="emphasis"><em>fakeroot</em></span> package will enable creation of the Debian package without using administrator's rights.
			</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title" id="section.sources-noyau">8.10.2. Getting the Sources</h3></div></div></div><a id="idp10639016" class="indexterm"></a><a id="idp10639480" class="indexterm"></a><div class="para"><p></p>
				Like anything that can be useful on a Debian system, the Linux kernel sources are available in a package. To retrieve them, just install the <span class="pkg pkg">linux-source-<em class="replaceable"><code>version</code></em></span> package. The <code class="command">apt-cache search ^linux-source</code> command lists the various kernel versions packaged by Debian. The latest version is available in the <span class="distribution distribution">Unstable</span> distribution: you can retrieve them without much risk (especially if your APT is configured according to the instructions of <a class="xref" href="sect.apt-get.html#section.apt-mix-distros">Section 6.2.6, “Working with Several Distributions”</a>). Note that the source code contained in these packages does not correspond precisely with that published by Linus Torvalds and the kernel developers; like all distributions, Debian applies a number of patches. These modifications include patches (some relevant to security problems) that are waiting to be included in the next version of the kernel, as well as some features that are specific to Debian (like cramfs, a filesystem specifically for the <code class="filename">initrd</code> image).
			</div><div class="sidebar"><div class="titlepage"><div><div><h6><span class="emphasis"><em>CULTURE</em></span> Names of kernel packages</h6></div></div></div><div class="para"><p></p>
				Historically, packages containing the Debian kernel were called <span class="pkg pkg">kernel-image-*</span>, but they all actually contained a Linux kernel. Since Debian works with other kernels (Hurd or FreeBSD, for example), this was confusing. Nowadays, the packages are called “<span class="pkg pkg">linux-image-*</span>"; the <span class="pkg pkg">kernel-image-*</span> packages are now empty shells and their only purpose is to facilitate the transition. Source packages for the Linux kernel are also called “<span class="pkg pkg">linux-source-*</span>”. As for packages containing patches, the transition is still in progress so both <span class="pkg pkg">linux-patch-*</span> packages and <span class="pkg pkg">kernel-patch-*</span> can still be found. <span class="pkg pkg">kernel-package</span> remains <span class="pkg pkg">kernel-package</span>, since it is not specific to Linux (it could, for example, prepare FreeBSD kernel packages).
			</div></div><div class="para"><p></p>
				The remainder of this section focuses on the 2.6.32 version of the Linux kernel, but the examples can, of course, be adapted to the particular version of the kernel that you want.
			</div><div class="para"><p></p>
				We assume the <span class="pkg pkg">linux-source-2.6.32</span> package has been installed. It contains <code class="filename">/usr/src/linux-source-2.6.32.tar.bz2</code>, a compressed archive of the kernel sources. You must extract these files in a new directory (not directly under <code class="filename">/usr/src/</code>, since there is no need for special permissions to compile a Linux kernel): <code class="filename">~/kernel/</code> is appropriate.
			</div><pre class="screen">
<code class="computeroutput">$ </code><strong class="userinput"><code>mkdir ~/kernel; cd ~/kernel</code></strong>
<code class="computeroutput">$ </code><strong class="userinput"><code>tar -xjf /usr/src/linux-source-2.6.32.tar.bz2</code></strong></pre><div class="sidebar important"><div class="titlepage"><div><div><h6><span class="emphasis"><em>CULTURE</em></span> Location of kernel sources</h6></div></div></div><div class="para"><p></p>
				Traditionally, Linux kernel sources would be placed in <code class="filename">/usr/src/linux/</code> thus requiring root permissions for compilation. However, working with administrator rights should be avoided when not needed. There is a <code class="literal">src</code> group that allows members to work in this directory, but working in <code class="filename">/usr/src/</code> should be avoided nevertheless. By keeping the kernel sources in a personal directory, you get security on all counts: no files in <code class="filename">/usr/</code> not known to the packaging system, and no risk of misleading programs that read <code class="filename">/usr/src/linux</code> when trying to gather information on the used kernel.
			</div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title" id="section.config-noyau">8.10.3. Configuring the Kernel</h3></div></div></div><a id="idp10653496" class="indexterm"></a><a id="idp10654200" class="indexterm"></a><div class="para"><p></p>
				The next step consists of configuring the kernel according to your needs. The exact procedure depends on the goals.
			</div><div class="para"><p></p>
				When recompiling a more recent version of the kernel (possibly with an additional patch), the configuration will most likely be kept as close as possible to that proposed by Debian. In this case, and rather than reconfiguring everything from scratch, it is sufficient to copy the <code class="filename">/boot/config-<em class="replaceable"><code>version</code></em></code> file (the version is that of the kernel currently used, which can be found with the <code class="command">uname -r</code> command) into a <code class="filename">.config</code> file in the directory containing the kernel sources.
			</div><pre class="screen">
<code class="computeroutput">$ </code><strong class="userinput"><code>cp /boot/config-2.6.32-5-686 ~/kernel/linux-source-2.6.32/.config</code></strong></pre><div class="para"><p></p>
				Unless you need to change the configuration, you can stop here and skip to the next section. If you need to change it, on the other hand, or if you decide to reconfigure everything from scratch, you must take the time to configure your kernel. There are various dedicated interfaces in the kernel source directory that can be used by calling the <code class="command">make <em class="replaceable"><code>target</code></em></code> command, where <em class="replaceable"><code>target</code></em> is one of the values described below.
			</div><div class="para"><p></p>
				<code class="command">make menuconfig</code> compiles and executes an text-mode interface (this is where the <span class="pkg pkg">libncurses5-dev</span> package is required) which allows navigating the options available in a hierarchical structure. Pressing the <span class="keycap"><strong>Space</strong></span> key changes the value of the selected option, and <span class="keycap"><strong>Enter</strong></span> validates the button selected at the bottom of the screen; <span class="guibutton"><strong>Select</strong></span> returns to the selected sub-menu; <span class="guibutton"><strong>Exit</strong></span> closes the current screen and move back up in the hierarchy; <span class="guibutton"><strong>Help</strong></span> will display more detailed information on the role of the selected option. The arrows allow moving within the list of options and buttons. To exit the configuration program, choose <span class="guibutton"><strong>Exit</strong></span> from the main menu. The program then offers to save the changes you've made; accept if you are satisfied with your choices.
			</div><div class="para"><p></p>
				Other interfaces have similar features, but they work within more modern graphical interfaces; such as <code class="command">make xconfig</code> which uses a Qt graphical interface, and <code class="command">make gconfig</code> which uses GTK+. The former requires <span class="pkg pkg">libqt3-mt-dev</span>, while the latter depends on <span class="pkg pkg">libglade2-dev</span> and <span class="pkg pkg">libgtk2.0-dev</span>.
			</div><div class="para"><p></p>
				The <code class="command">make-kpkg</code> command, presented in the next paragraph, runs <code class="command">make oldconfig</code> automatically to ensure the presence of a kernel configuration. This configuration method simply reuses the choices saved in the <code class="filename">.config</code> file. If there is no such file, it behaves like <code class="command">make config</code>, a text interface that asks all questions (hundreds of them) one a time. If the <code class="filename">.config</code> file already exists but doesn't mention all the existing options, then this method will only ask questions for which the file has no saved answer.
			</div><div class="sidebar fil"><div class="titlepage"><div><div><h6><span class="emphasis"><em>TIP</em></span> <code class="command">make-kpkg --config</code></h6></div></div></div><div class="para"><p></p>
				<code class="command">make-kpkg</code> can be told to use configuration methods other than <code class="command">make oldconfig</code>, by indicating the target (<code class="literal">menuconfig</code>, <code class="literal">xconfig</code> or <code class="literal">gconfig</code>) in the <code class="command">make-kpkg</code> invocation with the <code class="literal">--config</code> option.
			</div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title" id="section.compilation-generation-noyau">8.10.4. Compiling and Building the Package</h3></div></div></div><a id="idp10669056" class="indexterm"></a><a id="idp10669616" class="indexterm"></a><a id="idp10670480" class="indexterm"></a><a id="idp10671344" class="indexterm"></a><a id="idp10672224" class="indexterm"></a><div class="sidebar fil"><div class="titlepage"><div><div><h6><span class="emphasis"><em>NOTE</em></span> Clean up before rebuilding</h6></div></div></div><a id="idp10673784" class="indexterm"></a><div class="para"><p></p>
				If you have already compiled once in the directory and wish to recompile with new sources, you must run <code class="command">fakeroot make-kpkg clean</code>. Additionally, this allows generating a package with a new name (different <code class="literal">--append-to-version</code> setting).
			</div></div><div class="sidebar"><div class="titlepage"><div><div><h6><span class="emphasis"><em>TIP</em></span> Kernel package headers</h6></div></div></div><div class="para"><p></p>
				<code class="command">make-kpkg</code> uses information contained in the <code class="filename">/etc/kernel-pkg.conf</code> file to generate headers for the Debian kernel package. It is recommended to edit this file with correct information if you wish to publish your kernel package.
			</div></div><div class="para"><p></p>
				Once the kernel configuration is ready, the <code class="command">make-pkg</code> command provided by Debian compiles the kernel, then generates the corresponding Debian package (or packages). Just like <code class="command">make</code>, <code class="command">make-pkg</code> takes the name of a target to execute as an argument: <code class="literal">kernel-image</code> generates a compiled kernel package, <code class="literal">kernel-doc</code> a package containing the documentation included with the kernel, <code class="literal">kernel-headers</code> a package of kernel header files (<code class="filename">.h</code> files for the kernel in the <code class="filename">include/</code> directory, which is useful for compilation of some external modules), and <code class="literal">kernel-source</code> creates a package containing the kernel sources.
			</div><div class="para"><p></p>
				<code class="command">make-kpkg</code> also accepts several parameters: <code class="literal">--append-to-version <em class="replaceable"><code>suffix</code></em></code> appends <em class="replaceable"><code>suffix</code></em> to the name of the kernel; the suffix is also included in the package name. <code class="literal">--revision <em class="replaceable"><code>revision</code></em></code> defines the version number of the package generated. Debian uses certain suffixes to identify standard kernels, compiled specifically for a given processor, or with certain options (<code class="literal">-486</code>, <code class="literal">-686</code>, <code class="literal">-686-bigmem</code>, <code class="literal">-amd64</code>, <code class="literal">-vserver-686</code>, <code class="literal">-vserver-686-bigmem</code>, <code class="literal">-openvz-686</code>, <code class="literal">-xen-686</code>). These suffixes are best avoided for local packages, so that they can be easily recognized from official packages issued by the Debian project.
			</div><div class="para"><p></p>
				The <code class="command">make-kpkg</code> program performs actions normally restricted to the root user when creating the Debian package; however, it can be tricked into working under a normal user's identity, with <code class="command">fakeroot</code> (see sidebar <a class="xref" href="debian-packaging.html#cadre.fakeroot"><span class="emphasis"><em>TOOL</em></span> <code class="command">fakeroot</code></a>).
			</div><pre class="screen scale">
<code class="computeroutput">$ </code><strong class="userinput"><code>fakeroot make-kpkg --append-to-version -falcot --revision 1 --initrd kernel-image</code></strong> 
[...]
<code class="computeroutput">$ </code><strong class="userinput"><code>ls ../*.deb</code></strong>
<code class="computeroutput">../linux-image-2.6.32-falcot_1_i386.deb</code></pre><div class="para"><p></p>
				As you can see, the package is created with the name “<code class="filename">linux-image-2.6.32-falcot_1_i386.deb</code>”.
			</div></div><div class="section"><div class="titlepage"><div><div><h3 class="title" id="section.compilation-modules">8.10.5. Compiling External Modules</h3></div></div></div><a id="idp10687408" class="indexterm"></a><a id="idp10688272" class="indexterm"></a><a id="idp10688976" class="indexterm"></a><div class="para"><p></p>
				Some modules are maintained outside of the official Linux kernel. To use them, they must be compiled alongside the matching kernel. A number of common third party modules are provided by Debian in dedicated packages: <span class="pkg pkg">lustre-source</span> for the Lustre filesystem, <span class="pkg pkg">qc-usb-source</span> for the drivers for some USB webcams (Logitech QuickCam Express), etc.
			</div><div class="para"><p></p>
				These external packages are many and varied and we won't list them all here; the <code class="command">apt-cache search source$</code> command can narrow down the search field. However, a complete list isn't particularly useful since there is no particular reason for compiling external modules except when you know you need it. In such cases, the device's documentation will typically detail the specific module(s) it needs to function under Linux.
			</div><div class="para"><p></p>
				For example, let's look at the <span class="pkg pkg">qc-usb-source</span> package: after installation, a <code class="filename">.tar.gz</code> of the module's sources is stored in <code class="filename">/usr/src/</code>. These sources must then be extracted to the working directory:
			</div><pre class="screen">
<code class="computeroutput">$ </code><strong class="userinput"><code>cd ~/kernel/</code></strong>
<code class="computeroutput">$ </code><strong class="userinput"><code>tar xjf /usr/src/qc-usb.tar.bz2</code></strong>
<code class="computeroutput">$ </code><strong class="userinput"><code>ls modules/</code></strong>
<code class="computeroutput">qc-usb</code></pre><div class="sidebar important"><div class="titlepage"><div><div><h6><span class="emphasis"><em>NOTE</em></span> Save the settings</h6></div></div></div><div class="para"><p></p>
				When using the <code class="command">make-kpkg modules-image</code> command, it is important to use the same <code class="literal">--append-to-version</code> setting used in the previous use of the command (probably <code class="command">make-kpkg kernel-image</code>), since its value affects the name of the directory in which the modules are installed, which must correspond to the kernel version.
			</div><div class="para"><p></p>
				Note that <code class="command">make-kpkg</code> must still be invoked from the kernel sources directory, even when compiling external modules located in other directories.
			</div></div><div class="para"><p></p>
				The module sources are now located in the <code class="filename">~/kernel/modules/qc-usb/</code> directory. To compile these modules and create a Debian package, we invoke <code class="command">make-kpkg</code> with the <code class="literal">modules-image</code> target and indicate the location of the modules via the <code class="varname">MODULE_LOC</code> environment variable (without this variable, it uses <code class="filename">/usr/src/modules/</code>, which won't work in our case). By default, it tries to create the packages for all the external modules that can be found at this location extracted. The <code class="literal">--added-modules</code> option allows to explicitly choose the external modules to compile. To include more than one, separate them with a comma.
			</div><pre class="screen">
<code class="computeroutput">$ </code><strong class="userinput"><code>export MODULE_LOC=~/kernel/modules</code></strong>
<code class="computeroutput">$ </code><strong class="userinput"><code>cd ~/kernel/linux-source-2.6.32</code></strong>
<code class="computeroutput">$ </code><strong class="userinput"><code>fakeroot make-kpkg --append-to-version -falcot modules-image</code></strong>
<code class="computeroutput">[...]
Module /home/roland/kernel/modules/qc-usb processed fine
$ </code><strong class="userinput"><code>ls ../*.deb</code></strong>
<code class="computeroutput">../linux-image-2.6.32-falcot_1_i386.deb
../qc-usb-modules-2.6.32-falcot_0.6.6-7+1_i386.deb</code></pre><div class="sidebar"><div class="titlepage"><div><div><h6><span class="emphasis"><em>TIP</em></span> Automating the process</h6></div></div></div><a id="idp10701888" class="indexterm"></a><a id="idp10702584" class="indexterm"></a><div class="para"><p></p>
				The whole process can be automated with <span class="pkg pkg">module-assistant</span>. This package was specifically designed to install the required tools and packages, compile an external module, and install it. Thus, the <code class="command">m-a a-i qc-usb-source</code> command compiles the driver for the current kernel and installs it on the fly.
			</div><div class="para"><p></p>
				The next step in automation is <span class="pkg pkg">dkms</span>, which automates the process from the time it is installed; the modules that use it (the <span class="pkg pkg">*.dkms</span> packages) are automatically compiled at the time of installation, for any kernel(s) currently installed; DKMS also takes into account the installation of new kernels, their updates, and removal of obsolete modules upon deletion of a kernel package. This system is more recent (it didn't exist in <span class="distribution distribution">Lenny</span>), and it has not yet been generalized, but some modules already use it. For instance, simply installing the <span class="pkg pkg">virtualbox-ose-dkms</span> package ensures that the modules necessary for the VirtualBox virtualization system are available for all installed kernels, with no manual intervention required. It is necessary, however, to install the <span class="pkg pkg">linux-headers-*</span> package that matches to the installed kernel. The easiest way to do so is to install the corresponding meta-package; for instance, if you use <span class="pkg pkg">linux-images-2.6-686</span>, you would install <span class="pkg pkg">linux-headers-2.6-686</span>.
			</div></div></div><div class="section"><div class="titlepage"><div><div><h3 class="title" id="section.patch-noyau">8.10.6. Applying a Kernel Patch</h3></div></div></div><a id="idp10708784" class="indexterm"></a><a id="idp10709504" class="indexterm"></a><div class="para"><p></p>
				Some features are not included in the standard kernel due to a lack of maturity or to some disagreement between the maintainer of the source code and the kernel maintainers. Such features may be distributed as patches that anyone is free to apply to the kernel sources.
			</div><div class="para"><p></p>
				Debian distributes some of these patches in <span class="pkg pkg">linux-patch-*</span> or <span class="pkg pkg">kernel-patch-*</span> packages (for instance, <span class="pkg pkg">linux-patch-grsecurity2</span>, which tightens some of the kernel's security policies). These packages install files in the <code class="filename">/usr/src/kernel-patches/</code> directory.
			</div><div class="para"><p></p>
				To apply one or more of these installed patches, use the <code class="command">patch</code> command in the sources directory then start compilation of the kernel as described above.
			</div><pre class="screen">
<code class="computeroutput">$ </code><strong class="userinput"><code>cd ~/kernel/linux-source-2.6.32</code></strong>
<code class="computeroutput">$ </code><strong class="userinput"><code>fakeroot make-kpkg clean</code></strong>
<code class="computeroutput">$ </code><strong class="userinput"><code>zcat /usr/src/kernel-patches/diffs/grsecurity2/grsecurity-2.1.14-2.6.32.13-201005151340.patch.gz | patch -p1</code></strong>
<code class="computeroutput">$ </code><strong class="userinput"><code>fakeroot make-kpkg --append-to-version -grsec --revision 1 --initrd kernel-image</code></strong>
<code class="computeroutput">$ </code><strong class="userinput"><code>ls ../*.deb</code></strong>
<code class="computeroutput">../linux-image-2.6.32-falcot_1_i386.deb
../qc-usb-modules-2.6.32-falcot_0.6.6-7+1_i386.deb
../linux-image-2.6.32-grsec_1_i386.deb</code></pre><div class="sidebar"><div class="titlepage"><div><div><h6><span class="emphasis"><em>NOTE</em></span> <code class="command">make-kpkg --added-patches</code></h6></div></div></div><div class="para"><p></p>
				Until <span class="distribution distribution">Lenny</span>, <code class="command">make-kpkg</code> was able to apply one or more patches on the fly during compilation of the kernel, which allowed replacing the manual patching and unpatching with a command line option (in our example, <code class="literal">--added-patches grsecurity2</code>). This feature was removed from the current version in <span class="distribution distribution">Squeeze</span> since it was too fragile when faced with the huge variety of possible situations. In simple cases with a single patch, the patch can be applied manually; for situations involving complex combinations of patches, it is preferable to use a version tracking system such as Git, which will make the task easier (especially since patches are generally distributed by their authors in this form).
			</div></div><div class="para"><p></p>
				Note that a given patch may not necessarily work with every version of the kernel; it is possible for <code class="command">patch</code> to fail when applying them to kernel sources. An error message will be displayed and give some details about the failure; in this case, refer to the documentation available in the Debian package of the patch (in the <code class="filename">/usr/share/doc/linux-patch-*/</code> directory). In most cases, the maintainer indicates for which kernel versions their patch is intended.
			</div></div></div><div id="site_footer"></div><script type="text/javascript">
		$("#site_footer").load("../../../../../footer.html");
	</script><ul class="docnav"><li class="previous"><a accesskey="p" href="sect.config-misc.html"><strong>Prev</strong>8.9. Other Configurations: Time Synchronization, ...</a></li><li class="up"><a accesskey="u" href="#"><strong>Up</strong></a></li><li class="home"><a accesskey="h" href="index.html"><strong>Home</strong></a></li><li class="next"><a accesskey="n" href="sect.kernel-installation.html"><strong>Next</strong>8.11. Installing a Kernel</a></li></ul></body></html>
